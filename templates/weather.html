<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Thá»i tiáº¿t SÃ i GÃ²n</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .weather-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 80px 2rem 2rem;
      color: #fff;
    }
    .current-weather {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 80%;
      background: #1e293b;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      margin-bottom: 2rem;
    }
    .temp {
      font-size: 5rem;
      font-weight: 600;
      text-align: center;
    }
    .details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      text-align: center;
    }
    .details div {
      background: #0f172a;
      border-radius: 8px;
      padding: 10px;
    }
    /* Khá»‘i chá»©a toÃ n bá»™ pháº§n dá»± bÃ¡o 7 ngÃ y */
    .forecast {
        display: flex;
        flex-wrap: wrap;           /* Cho phÃ©p xuá»‘ng dÃ²ng khi thiáº¿u chá»— */
        justify-content: center;   /* CÄƒn giá»¯a cÃ¡c tháº» */
        gap: 1rem;
        padding: 1rem 2rem;
        width: 80%;                /* Báº±ng pháº§n current-weather */
        max-width: 1200px;
        margin: 0 auto;
        box-sizing: border-box;
    }

    /* Má»—i card dá»± bÃ¡o */
    .forecast-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 1rem;
        flex: 1 1 120px;             /* linh Ä‘á»™ng theo chiá»u ngang */
        min-width: 120px;            /* khÃ´ng nhá» quÃ¡ */
        text-align: center;
        color: #fff;
        transition: transform 0.2s ease;
    }

    .forecast-card:hover {
        transform: scale(1.05);
    }

    /* Responsive cho mÃ n nhá» hÆ¡n (mobile) */
    @media (max-width: 768px) {
        .forecast {
            width: 95%;
            padding: 0.5rem;
        }
        .day {
            flex: 1 1 100px;
            min-width: 100px;
        }
    }

    .day {
        background: #1e293b;
        border-radius: 10px;
        padding: 10px;
        flex: 1 1 140px;           /* Co giÃ£n tá»± Ä‘á»™ng */
        max-width: 160px;
        min-width: 120px;
        text-align: center;
        transition: transform 0.2s ease;
    }

    .day:hover {
        transform: scale(1.05);
    }

    .day img {
        width: 60px;
        height: 60px;
    }
  </style>
</head>
<body class="slide-page">
  <header class="topbar">
    <div class="brand">ğŸŒ¤ Thá»i tiáº¿t SÃ i GÃ²n</div>
    <div class="datetime" id="clock">--:--:--</div>
  </header>

  <div class="weather-container">
    {% set current = data["current"] %}
    {% set fc = data["forecast"] %}
    {% set air = data["air"] %}

    <div class="current-weather">
      <div>
        <h2>{{ current["name"] }}</h2>
        <p>{{ current["weather"][0]["description"] | capitalize }}</p>
        <div class="temp">{{ current["main"]["temp"]|round }}Â°C</div>
        <p>Cáº£m giÃ¡c nhÆ°: {{ current["main"]["feels_like"]|round }}Â°</p>
      </div>
      <div class="details">
        <div>ğŸŒ… BÃ¬nh minh<br>{{ current["sys"]["sunrise"] | datetimeformat }}</div>
        <div>ğŸŒ‡ HoÃ ng hÃ´n<br>{{ current["sys"]["sunset"] | datetimeformat }}</div>
        <div>ğŸ’¨ GiÃ³<br>{{ current["wind"]["speed"] }} m/s</div>
        <div>ğŸ’§ Äá»™ áº©m<br>{{ current["main"]["humidity"] }}%</div>
        <div>ğŸŒ¡ï¸ Ãp suáº¥t<br>{{ current["main"]["pressure"] }} hPa</div>
        <div>ğŸŒ«ï¸ Táº§m nhÃ¬n<br>{{ (current["visibility"]/1000)|round(1) }} km</div>
      </div>
    </div>

    <h3>Dá»± bÃ¡o 7 ngÃ y tá»›i</h3>
    <div class="forecast">
    {% set days = {} %}
    {% for item in fc["list"] %}
        {% set date = item.dt_txt.split(" ")[0] %}
        {% if date not in days %}
        {% set _ = days.update({date: item}) %}
        {% endif %}
    {% endfor %}

    {% for date, item in days.items() %}
        <div class="day">
        <p>{{ date[5:] }}</p>
        <img src="http://openweathermap.org/img/wn/{{ item.weather[0].icon }}@2x.png" alt="">
        <p>{{ item.weather[0].description }}</p>
        <p>{{ item.main.temp_max|round }}Â° / {{ item.main.temp_min|round }}Â°</p>
        </div>
    {% endfor %}
    </div>

    </div>
  </div>

  <script>
    const pages = ["/weather", "/gold", "/crypto", "/stock", "/news", "/finance"];
    let idx = pages.indexOf(window.location.pathname);
    if (idx === -1) idx = 0;
    setInterval(() => {
      idx = (idx + 1) % pages.length;
      window.location.href = pages[idx];
    }, 120000);

    document.body.classList.add("slide-page");
    document.body.style.transition = "transform 0.7s ease-in-out, opacity 0.7s ease-in-out";
    document.body.style.transform = "translateX(0)";
    document.body.style.opacity = "1";
    window.addEventListener("beforeunload", () => {
      document.body.style.transform = "translateX(-50px)";
      document.body.style.opacity = "0";
    });

    function updateClock() {
      const now = new Date();
      const opts = { timeZone: 'Asia/Ho_Chi_Minh', hour12: false,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit' };
      const clock = document.getElementById('clock');
      if (clock) clock.textContent = new Intl.DateTimeFormat('vi-VN', opts).format(now);
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ======= Preload images (OpenWeather icons + local icons) ======= */
    (function preloadImages() {
    const imgs = [
        // OpenWeather sample icons you might use (replace with icons your template actually uses)
        "http://openweathermap.org/img/wn/01d@2x.png",
        "http://openweathermap.org/img/wn/02d@2x.png",
        "http://openweathermap.org/img/wn/03d@2x.png",
        "http://openweathermap.org/img/wn/04d@2x.png",
        "http://openweathermap.org/img/wn/09d@2x.png",
        "http://openweathermap.org/img/wn/10d@2x.png",
        // local icons (example)
        "/static/img/weather/clear.png",
        "/static/img/weather/cloud.png",
        "/static/img/weather/rain.png"
    ];
    imgs.forEach(url => {
        const i = new Image();
        i.src = url;
    });
    })();

    /* ======= Preload TradingView script and warm it up offscreen ======= */
    (function warmupTradingView() {
        // náº¿u already loaded thÃ¬ thÃ´i
        if (window.TradingView) return;

        // 1) táº£i script vÃ o bá»™ nhá»› (no blocking)
        const s = document.createElement('script');
        s.src = "https://s3.tradingview.com/tv.js";
        s.async = true;
        s.onload = () => {
            try {
            // 2) táº¡o offscreen container Ä‘á»ƒ init 1 widget "nháº¹" (Ä‘áº·t symbol rá»—ng)
            const off = document.createElement('div');
            off.style.position = 'fixed';
            off.style.left = '-9999px';
            off.style.width = '1px';
            off.style.height = '1px';
            off.id = 'tv-warmup';
            document.body.appendChild(off);

            // create a minimal widget to warm caches (no toolbar)
            new TradingView.widget({
                "container_id": "tv-warmup",
                "width": 1,
                "height": 1,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "60",
                "theme": "dark",
                "locale": "en",
                "hide_side_toolbar": true,
                "allow_symbol_change": false,
                "enable_publishing": false
            });

            // remove warmup after short delay
            setTimeout(() => {
                const el = document.getElementById('tv-warmup');
                if (el) el.remove();
            }, 2500);
            } catch (e) {
            // silent
            console.debug("TV warmup failed", e);
            }
        };
        s.onerror = () => console.warn("Cannot preload TradingView script");
        document.head.appendChild(s);

        // Also prefetch the TradingView css/resources by creating a link rel=prefetch
        const p = document.createElement('link');
        p.rel = 'prefetch';
        p.href = 'https://s3.tradingview.com/tv.js';
        document.head.appendChild(p);
    })();
  </script>
</body>
</html>
