<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Kiosk Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">

  <!-- Prefetch / Preload c√°c file tƒ©nh quan tr·ªçng -->
  <link rel="preload" href="/static/style.css" as="style">
  <link rel="preconnect" href="https://openweathermap.org" crossorigin>

  <!-- N·∫øu b·∫°n c√≥ c√°c icon local (v√≠ d·ª• weather icons custom), preload ch√∫ng -->
  <link rel="preload" href="/static/img/weather/clear.png" as="image">
  <link rel="preload" href="/static/img/weather/cloud.png" as="image">
  <!-- prefetch cho nh·ªØng assets kh√¥ng c·∫ßn ngay nh∆∞ng h·ªØu √≠ch -->
  <link rel="prefetch" href="/news" as="document">
  <link rel="prefetch" href="/market" as="document">
  <link rel="prefetch" href="/finance" as="document">
</head>
<body>
  <div id="app" class="slide-page">
    <header class="topbar">
      <div class="brand">Kiosk Dashboard</div>
      <div class="datetime" id="clock">--:--:--</div>
    </header>

    <main id="content">
      <h2 style="margin-top:4rem;">ƒêang t·∫£i d·ªØ li·ªáu...</h2>
    </main>
  </div>

  <script>
    // Danh s√°ch trang
    const pages = ["/weather", "/news", "/market", "/finance"];
    let idx = 0;
    const pageDuration = 180000; // 3 ph√∫t

    // üïí ƒê·ªìng h·ªì realtime
    function updateClock() {
      const now = new Date();
      const opts = { timeZone: 'Asia/Ho_Chi_Minh', hour12: false,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit' };
      document.getElementById('clock').textContent =
        new Intl.DateTimeFormat('vi-VN', opts).format(now);
    }
    updateClock();
    setInterval(updateClock, 1000);

    // üåô Hi·ªáu ·ª©ng slide khi chuy·ªÉn trang
    function goToPage(path) {
      const app = document.getElementById('app');
      app.classList.add('slide-out');
      setTimeout(() => { window.location.href = path; }, 700);
    }

    // üöÄ T·ª± ƒë·ªông m·ªü trang ƒë·∫ßu ti√™n sau 1 gi√¢y
    setTimeout(() => {
      goToPage(pages[0]); // /weather
    }, 1000);

    // üîÅ Auto chuy·ªÉn trang lu√¢n phi√™n (2 ph√∫t)
    setInterval(() => {
      idx = (idx + 1) % pages.length;
      goToPage(pages[idx]);
    }, pageDuration);

    /* ======= Preload images (OpenWeather icons + local icons) ======= */
    (function preloadImages() {
      const imgs = [
        // OpenWeather sample icons you might use (replace with icons your template actually uses)
        "http://openweathermap.org/img/wn/01d@2x.png",
        "http://openweathermap.org/img/wn/02d@2x.png",
        "http://openweathermap.org/img/wn/03d@2x.png",
        "http://openweathermap.org/img/wn/04d@2x.png",
        "http://openweathermap.org/img/wn/09d@2x.png",
        "http://openweathermap.org/img/wn/10d@2x.png",
        // local icons (example)
        "/static/img/weather/clear.png",
        "/static/img/weather/cloud.png",
        "/static/img/weather/rain.png"
      ];
      imgs.forEach(url => {
        const i = new Image();
        i.src = url;
      });
    })();

    async function prefetchJson() {
      try {
        // Ch·ªù 3 gi√¢y ƒë·ªÉ m·ªçi th·ª© ·ªïn ƒë·ªãnh r·ªìi m·ªõi t·∫£i s·∫µn d·ªØ li·ªáu
        await new Promise(r => setTimeout(r, 3000));

        console.log("üöÄ Prefetching dashboard data in background...");

        const endpoints = ["/weather", "/news", "/market", "/finance"];

        // G·ªçi t·ª´ng endpoint c√°ch nhau 1 gi√¢y (nh·∫π cho Raspberry Pi)
        endpoints.forEach((url, i) => {
          setTimeout(() => {
            fetch(url, { cache: "no-store" })
              .then(r => console.log("Prefetched:", url, r.status))
              .catch(err => console.warn("Prefetch failed:", url, err));
          }, i * 1000);
        });

      } catch (e) {
        console.warn("PrefetchJson error:", e);
      }
    }

    // G·ªçi sau khi t·∫•t c·∫£ page ch√≠nh load xong
    window.addEventListener("load", prefetchJson);
  </script>
</body>
</html>
